---
- name: Grafana configuration
  hosts: grafana
  remote_user: ubuntu
  tasks:
    - name: Update apt repo and cache
      become: true
      apt:
        update_cache: yes
        force_apt_get: yes
        cache_valid_time: 3600
    - name: Upgrade all packages
      become: true
      apt:
        upgrade: dist
        force_apt_get: yes
    - name: Install openjdk 11
      become: true
      apt:
        name: openjdk-11-jdk
        state: present
        update_cache: yes
    - name: Install unzip
      become: true
      apt:
        name: unzip
        state: present
        update_cache: yes
    - name: Install net-tools
      become: true
      apt:
        name: net-tools
        state: present
        update_cache: yes
    - name: Install adduser
      become: true
      apt:
        name: adduser
        state: present
        update_cache: yes
    - name: Install libfontconfig1
      become: true
      apt:
        name: libfontconfig1
        state: present
        update_cache: yes
    - name: Download grafana .deb
      become: true
      get_url:
        url: https://dl.grafana.com/enterprise/release/grafana-enterprise_9.4.7_amd64.deb
        dest: /opt/grafana-enterprise_9.4.7_amd64.deb
        mode: 0440
    - name: Install grafana debian package
      become: true
      command: "dpkg -i /opt/grafana-enterprise_9.4.7_amd64.deb"
    - name: Remove grafana .deb
      become: true
      file:
        path: /opt/grafana-enterprise_9.4.7_amd64.deb
        state: absent
    - name: Enable grafana service
      become: true
      systemd:
        name: grafana-server.service
        enabled: true
        masked: no
    - name: Start grafana service
      become: true
      systemd:
        name: grafana-server.service
        state: started
        enabled: true