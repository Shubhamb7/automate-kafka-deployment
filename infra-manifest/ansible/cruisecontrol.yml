---
- name: Cruise Control configuration
  hosts: cruise
  remote_user: ubuntu
  vars:
    kafka_ips: ""
    zoo_ips: ""
  tasks:
  - name: Create sys log directory
    become: true
    file:
      path: "/opt/cruise/syslogs/"
      state: directory
      mode: '0755'
  - name: Get public ip of Cruise Control server
    command: curl --silent --fail http://ifconfig.me/ip
    register: cruise_public_ip
  - name: Clone Cruise Control Branch 2.5.116
    become: true
    git:
      repo: https://github.com/linkedin/cruise-control.git
      dest: /opt/cruise/cruise-control
      single_branch: yes
      version: 2.5.116
  - name: Download Cruise Control UI v0.4.0
    become: true
    get_url:
      url: https://github.com/linkedin/cruise-control-ui/releases/download/v0.4.0/cruise-control-ui-0.4.0.tar.gz
      dest: /opt/cruise/cruise-control/cruise-control-control-ui-0.4.0.tar.gz
      mode: 0440
  - name: Extract cruise-control-ui-0.4.0.tar.gz
    become: true
    unarchive:
      src: /opt/cruise/cruise-control/cruise-control-control-ui-0.4.0.tar.gz
      dest: /opt/cruise/cruise-control/
      remote_src: yes
  - name: Remove existing cruisecontrol properties file
    become: true
    file:
      path: /opt/cruise/cruise-control/config/cruisecontrol.properties
      state: absent
  - name: Remove existing cruisecontrol capacityCores file
    become: true
    file:
      path: /opt/cruise/cruise-control/config/capacityCores.json
      state: absent
  - name: Remove existing cruisecontrol capacityJBOD file
    become: true
    file:
      path: /opt/cruise/cruise-control/config/capacityJBOD.json
      state: absent
  - name: Upload local cruisecontrol capacityCores file to the server
    become: true
    copy:
      src: /opt/ansible-files/capacityCores.json
      dest: /opt/cruise/cruise-control/config/
      owner: root
      group: root
      mode: 0644
  - name: Upload local cruisecontrol capacityJBOD file to the server
    become: true
    copy:
      src: /opt/ansible-files/capacityJBOD.json
      dest: /opt/cruise/cruise-control/config/
      owner: root
      group: root
      mode: 0644
  - name: Generate cruisecontrol properties from template
    become: true
    template:
      src: /opt/ansible-files/cruisecontrol.properties.j2
      dest: /opt/cruise/cruise-control/config/cruisecontrol.properties
  - name: Generate config.csv for cruise control ui from template
    become: true
    template:
      src: /opt/ansible-files/config.csv.j2
      dest: /opt/cruise/cruise-control/cruise-control-ui/dist/static/config.csv
  - name: Upload local cruise control service file to the servers
    become: true
    copy:
      src: /opt/ansible-files/cruise.service
      dest: /etc/systemd/system/
      owner: root
      group: root
      mode: 0644
  - name: Remove cruise control ui tar file
    become: true
    file:
      path: /opt/cruise/cruise-control/cruise-control-control-ui-0.4.0.tar.gz
      state: absent
  - name: Run gradlew and build jar
    become: true
    shell: ./gradlew jar copyDependantLibs
    args:
      chdir: /opt/cruise/cruise-control/
    register: gradle_output
    no_log: true
  - name: just force systemd to reread configs
    become: true
    systemd:
      daemon_reload: yes
  - name: Enable cruise control service
    become: true
    systemd:
      name: cruise.service
      enabled: true
      masked: no
  
  # - name: Start kafka service
  #   become: true
  #   systemd:
  #     name: kafka.service
  #     state: started
  #     enabled: true
